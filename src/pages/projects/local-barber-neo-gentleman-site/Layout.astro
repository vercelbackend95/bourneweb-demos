---
const {
  title = "Neo Gentleman · Barber Demo",
  description = "Premium barber demo hero"
} = Astro.props;

import "./_local-barber-neo-gentleman-site.css";
import TopNav from "./TopNav.astro";
import StickyBookPill from "./StickyBookPill.astro";
---

<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="description" content={description} />
    <title>{title}</title>

    <script is:inline>
      if ("scrollRestoration" in history) history.scrollRestoration = "manual";

      // Hash-e sekcji, które NIE mają wymuszać lądowania w środku strony przy starcie/reload
      const SECTION_HASHES = new Set(["#top", "#gallery", "#services", "#products", "#book", "#shop"]);

      const navType = () => {
        const nav = performance.getEntriesByType?.("navigation")?.[0];
        if (nav && typeof nav.type === "string") return nav.type; // navigate | reload | back_forward | prerender
        const legacy = performance.navigation?.type; // 0/1/2 (stare)
        return legacy === 1 ? "reload" : legacy === 2 ? "back_forward" : "navigate";
      };

      const isHardLoad = () => {
        const t = navType();
        return t === "navigate" || t === "reload";
      };

      const shouldForceTop = () => {
        if (!isHardLoad()) return false;
        if (!location.hash) return true;
        return SECTION_HASHES.has(location.hash);
      };

      const stripHash = () => {
        if (!location.hash) return;
        history.replaceState(null, document.title, location.pathname + location.search);
      };

      const forceTop = () => {
        if (!shouldForceTop()) return;

        // wyczyść hash, żeby mobile nie zapamiętywał "Services" jako start
        stripHash();

        // natychmiast
        document.documentElement.scrollTop = 0;
        document.body.scrollTop = 0;

        // po layout/paint + po dogrywaniu fontów/obrazów
        requestAnimationFrame(() => {
          window.scrollTo(0, 0);
          requestAnimationFrame(() => window.scrollTo(0, 0));
        });

        setTimeout(() => window.scrollTo(0, 0), 160);
      };

      window.addEventListener("DOMContentLoaded", forceTop);
      window.addEventListener("load", forceTop);
      window.addEventListener("pageshow", forceTop);          // Safari / bfcache
      document.addEventListener("astro:page-load", forceTop); // Astro navigations

      // ===== Open booking from sticky pill (or any element with data-bm-open-booking) =====
      document.addEventListener("click", (e) => {
        const t = e.target;
        if (!(t instanceof Element)) return;

        const trigger = t.closest("[data-bm-open-booking]");
        if (!trigger) return;

        // allow "open in new tab" etc. when it's a link
        const isLink = trigger instanceof HTMLAnchorElement;
        const mouse = e instanceof MouseEvent ? e : null;

        if (isLink) {
          if (mouse && mouse.button !== 0) return;
          if (e.metaKey || e.ctrlKey || e.shiftKey || e.altKey) return;
        }

        e.preventDefault();
        window.dispatchEvent(new CustomEvent("bm:open-booking"));
      });
    </script>

    <!-- Typography -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Playfair+Display:wght@600;700;800&display=swap"
      rel="stylesheet"
    />
  </head>

  <body class="bm-root">
    <!-- anchor for href="#top" -->
    <div id="top" class="bm-topAnchor" aria-hidden="true"></div>

    <TopNav />
    <slot />

    <StickyBookPill />
  </body>
</html>
