---
const {
  id = "shop",
  title = "Studio essentials",
  subtitle = "Take the finish home. Barber-grade products — clean hold, soft beard, zero grease.",
} = Astro.props;

import heartSvg from "./assets/heart.svg?raw";

// Make SVG predictable (strip huge width/height, then force UI size)
const heartIcon = heartSvg
  .replace(/\s(width|height)="[^"]*"/g, "")
  .replace("<svg", '<svg width="18" height="18"');
---

<section class="bm-products" id={id} aria-label="Shop essentials" data-bm-reveal>
  <div class="bm-products__inner">
    <div class="bm-products__top">
      <div>
        <p class="bm-products__kicker">SHOP</p>
        <h2 class="bm-products__title">{title}</h2>
        <p class="bm-products__sub">{subtitle}</p>
      </div>

      <div class="bm-products__ctaRow">
        <a class="bm-products__link" href="#book">Book a cut →</a>
        <a class="bm-products__ghost" href={`#${id}`}>View all products</a>
      </div>
    </div>

    <div class="bm-carousel" data-bm-carousel>
      <button class="bm-carArrow bm-carArrow--left" type="button" aria-label="Previous product" data-bm-prev>
        <span aria-hidden="true">←</span>
      </button>

      <div class="bm-viewport" data-bm-viewport tabindex="0" aria-label="Product carousel">
        <div class="bm-track" role="list" data-bm-track>
          <!-- 10 products -->
          <article class="bm-product" role="listitem" style="--d: 0ms">
            <div class="bm-product__media">
              <div class="bm-product__img bm-prod1" role="img" aria-label="Matte clay jar"></div>
              <div class="bm-product__badge">Bestseller</div>
            </div>
            <div class="bm-product__body">
              <div class="bm-product__head">
                <h3 class="bm-product__name">Matte Clay</h3>
                <div class="bm-product__price">£16</div>
              </div>
              <p class="bm-product__desc">Strong hold · matte finish · reworkable. Built for fades.</p>
              <div class="bm-product__meta">
                <span class="bm-pill">60g</span><span class="bm-pill">No shine</span><span class="bm-pill">All-day</span>
              </div>
              <div class="bm-product__actions">
                <button class="bm-buy" type="button" data-bm-buy="Matte Clay · £16">Quick add</button>
                <button class="bm-icon" type="button" aria-label="Save product">
                  <span aria-hidden="true" set:html={heartIcon}></span>
                </button>
              </div>
            </div>
          </article>

          <article class="bm-product" role="listitem" style="--d: 90ms">
            <div class="bm-product__media">
              <div class="bm-product__img bm-prod2" role="img" aria-label="Beard oil bottle"></div>
              <div class="bm-product__badge bm-product__badge--subtle">New</div>
            </div>
            <div class="bm-product__body">
              <div class="bm-product__head">
                <h3 class="bm-product__name">Beard Oil</h3>
                <div class="bm-product__price">£14</div>
              </div>
              <p class="bm-product__desc">Softens + tames · subtle scent · no itch. Daily driver.</p>
              <div class="bm-product__meta">
                <span class="bm-pill">30ml</span><span class="bm-pill">Non-greasy</span><span class="bm-pill">Fresh</span>
              </div>
              <div class="bm-product__actions">
                <button class="bm-buy" type="button" data-bm-buy="Beard Oil · £14">Quick add</button>
                <button class="bm-icon" type="button" aria-label="Save product">
                  <span aria-hidden="true" set:html={heartIcon}></span>
                </button>
              </div>
            </div>
          </article>

          <article class="bm-product" role="listitem" style="--d: 180ms">
            <div class="bm-product__media">
              <div class="bm-product__img bm-prod3" role="img" aria-label="Sea salt spray"></div>
              <div class="bm-product__badge">Editor’s pick</div>
            </div>
            <div class="bm-product__body">
              <div class="bm-product__head">
                <h3 class="bm-product__name">Sea Salt Spray</h3>
                <div class="bm-product__price">£12</div>
              </div>
              <p class="bm-product__desc">Texture + volume · natural grit · easy style in 10s.</p>
              <div class="bm-product__meta">
                <span class="bm-pill">150ml</span><span class="bm-pill">Texture</span><span class="bm-pill">Volume</span>
              </div>
              <div class="bm-product__actions">
                <button class="bm-buy" type="button" data-bm-buy="Sea Salt Spray · £12">Quick add</button>
                <button class="bm-icon" type="button" aria-label="Save product">
                  <span aria-hidden="true" set:html={heartIcon}></span>
                </button>
              </div>
            </div>
          </article>

          <article class="bm-product" role="listitem" style="--d: 270ms">
            <div class="bm-product__media">
              <div class="bm-product__img bm-prod4" role="img" aria-label="Beard balm tin"></div>
              <div class="bm-product__badge bm-product__badge--subtle">Classic</div>
            </div>
            <div class="bm-product__body">
              <div class="bm-product__head">
                <h3 class="bm-product__name">Beard Balm</h3>
                <div class="bm-product__price">£15</div>
              </div>
              <p class="bm-product__desc">Shape + nourish · medium hold · tidy edges all day.</p>
              <div class="bm-product__meta">
                <span class="bm-pill">50g</span><span class="bm-pill">Medium hold</span><span class="bm-pill">Smooth</span>
              </div>
              <div class="bm-product__actions">
                <button class="bm-buy" type="button" data-bm-buy="Beard Balm · £15">Quick add</button>
                <button class="bm-icon" type="button" aria-label="Save product">
                  <span aria-hidden="true" set:html={heartIcon}></span>
                </button>
              </div>
            </div>
          </article>

          <article class="bm-product" role="listitem" style="--d: 360ms">
            <div class="bm-product__media">
              <div class="bm-product__img bm-prod5" role="img" aria-label="Shampoo bottle"></div>
              <div class="bm-product__badge">Clean</div>
            </div>
            <div class="bm-product__body">
              <div class="bm-product__head">
                <h3 class="bm-product__name">Daily Shampoo</h3>
                <div class="bm-product__price">£13</div>
              </div>
              <p class="bm-product__desc">Fresh scalp · gentle wash · no squeak. Everyday use.</p>
              <div class="bm-product__meta">
                <span class="bm-pill">250ml</span><span class="bm-pill">Gentle</span><span class="bm-pill">Fresh</span>
              </div>
              <div class="bm-product__actions">
                <button class="bm-buy" type="button" data-bm-buy="Daily Shampoo · £13">Quick add</button>
                <button class="bm-icon" type="button" aria-label="Save product">
                  <span aria-hidden="true" set:html={heartIcon}></span>
                </button>
              </div>
            </div>
          </article>

          <article class="bm-product" role="listitem" style="--d: 450ms">
            <div class="bm-product__media">
              <div class="bm-product__img bm-prod6" role="img" aria-label="Conditioner bottle"></div>
              <div class="bm-product__badge bm-product__badge--subtle">Soft</div>
            </div>
            <div class="bm-product__body">
              <div class="bm-product__head">
                <h3 class="bm-product__name">Conditioner</h3>
                <div class="bm-product__price">£13</div>
              </div>
              <p class="bm-product__desc">Smooth finish · less frizz · easy comb. Barber-approved.</p>
              <div class="bm-product__meta">
                <span class="bm-pill">250ml</span><span class="bm-pill">Smooth</span><span class="bm-pill">Anti-frizz</span>
              </div>
              <div class="bm-product__actions">
                <button class="bm-buy" type="button" data-bm-buy="Conditioner · £13">Quick add</button>
                <button class="bm-icon" type="button" aria-label="Save product">
                  <span aria-hidden="true" set:html={heartIcon}></span>
                </button>
              </div>
            </div>
          </article>

          <article class="bm-product" role="listitem" style="--d: 540ms">
            <div class="bm-product__media">
              <div class="bm-product__img bm-prod7" role="img" aria-label="Pre-styler tonic"></div>
              <div class="bm-product__badge">Pro</div>
            </div>
            <div class="bm-product__body">
              <div class="bm-product__head">
                <h3 class="bm-product__name">Pre-Styler Tonic</h3>
                <div class="bm-product__price">£11</div>
              </div>
              <p class="bm-product__desc">Heat protection · light control · sets the shape fast.</p>
              <div class="bm-product__meta">
                <span class="bm-pill">120ml</span><span class="bm-pill">Heat safe</span><span class="bm-pill">Light hold</span>
              </div>
              <div class="bm-product__actions">
                <button class="bm-buy" type="button" data-bm-buy="Pre-Styler Tonic · £11">Quick add</button>
                <button class="bm-icon" type="button" aria-label="Save product">
                  <span aria-hidden="true" set:html={heartIcon}></span>
                </button>
              </div>
            </div>
          </article>

          <article class="bm-product" role="listitem" style="--d: 630ms">
            <div class="bm-product__media">
              <div class="bm-product__img bm-prod8" role="img" aria-label="Moustache wax tin"></div>
              <div class="bm-product__badge bm-product__badge--subtle">Detail</div>
            </div>
            <div class="bm-product__body">
              <div class="bm-product__head">
                <h3 class="bm-product__name">Moustache Wax</h3>
                <div class="bm-product__price">£10</div>
              </div>
              <p class="bm-product__desc">Tame edges · shape tips · strong control, no flakes.</p>
              <div class="bm-product__meta">
                <span class="bm-pill">30g</span><span class="bm-pill">Strong</span><span class="bm-pill">No flakes</span>
              </div>
              <div class="bm-product__actions">
                <button class="bm-buy" type="button" data-bm-buy="Moustache Wax · £10">Quick add</button>
                <button class="bm-icon" type="button" aria-label="Save product">
                  <span aria-hidden="true" set:html={heartIcon}></span>
                </button>
              </div>
            </div>
          </article>

          <article class="bm-product" role="listitem" style="--d: 720ms">
            <div class="bm-product__media">
              <div class="bm-product__img bm-prod9" role="img" aria-label="Beard brush"></div>
              <div class="bm-product__badge">Tool</div>
            </div>
            <div class="bm-product__body">
              <div class="bm-product__head">
                <h3 class="bm-product__name">Beard Brush</h3>
                <div class="bm-product__price">£9</div>
              </div>
              <p class="bm-product__desc">Even distribution · soft exfoliation · better shape daily.</p>
              <div class="bm-product__meta">
                <span class="bm-pill">Bristle</span><span class="bm-pill">Daily</span><span class="bm-pill">Clean</span>
              </div>
              <div class="bm-product__actions">
                <button class="bm-buy" type="button" data-bm-buy="Beard Brush · £9">Quick add</button>
                <button class="bm-icon" type="button" aria-label="Save product">
                  <span aria-hidden="true" set:html={heartIcon}></span>
                </button>
              </div>
            </div>
          </article>

          <article class="bm-product" role="listitem" style="--d: 810ms">
            <div class="bm-product__media">
              <div class="bm-product__img bm-prod10" role="img" aria-label="Pocket comb"></div>
              <div class="bm-product__badge bm-product__badge--subtle">Set</div>
            </div>
            <div class="bm-product__body">
              <div class="bm-product__head">
                <h3 class="bm-product__name">Pocket Comb</h3>
                <div class="bm-product__price">£7</div>
              </div>
              <p class="bm-product__desc">Always sharp. Keep your style in check — anywhere.</p>
              <div class="bm-product__meta">
                <span class="bm-pill">Travel</span><span class="bm-pill">Anti-static</span><span class="bm-pill">Clean</span>
              </div>
              <div class="bm-product__actions">
                <button class="bm-buy" type="button" data-bm-buy="Pocket Comb · £7">Quick add</button>
                <button class="bm-icon" type="button" aria-label="Save product">
                  <span aria-hidden="true" set:html={heartIcon}></span>
                </button>
              </div>
            </div>
          </article>
        </div>
      </div>

      <button class="bm-carArrow bm-carArrow--right" type="button" aria-label="Next product" data-bm-next>
        <span aria-hidden="true">→</span>
      </button>
    </div>

    <div class="bm-carNav" aria-label="Carousel pagination" data-bm-dots>
      <button class="bm-dot is-active" type="button" aria-label="Go to product 1" data-bm-dot="0"></button>
      <button class="bm-dot" type="button" aria-label="Go to product 2" data-bm-dot="1"></button>
      <button class="bm-dot" type="button" aria-label="Go to product 3" data-bm-dot="2"></button>
      <button class="bm-dot" type="button" aria-label="Go to product 4" data-bm-dot="3"></button>
      <button class="bm-dot" type="button" aria-label="Go to product 5" data-bm-dot="4"></button>
      <button class="bm-dot" type="button" aria-label="Go to product 6" data-bm-dot="5"></button>
      <button class="bm-dot" type="button" aria-label="Go to product 7" data-bm-dot="6"></button>
      <button class="bm-dot" type="button" aria-label="Go to product 8" data-bm-dot="7"></button>
      <button class="bm-dot" type="button" aria-label="Go to product 9" data-bm-dot="8"></button>
      <button class="bm-dot" type="button" aria-label="Go to product 10" data-bm-dot="9"></button>
    </div>

    <div class="bm-products__footer">
      <div class="bm-products__note">
        <strong>Pro move:</strong> upsell at checkout — “Add matte clay for £12” converts like crazy.
      </div>
      <a class="bm-products__all" href={`#${id}`}>Browse full shop →</a>
    </div>
  </div>

  <script is:inline>
    (function () {
      const section = document.querySelector('[data-bm-reveal]');
      if (!section) return;

      const reduce = window.matchMedia && window.matchMedia('(prefers-reduced-motion: reduce)').matches;

      // ===== Reveal =====
      const io = new IntersectionObserver((entries) => {
        entries.forEach((e) => {
          if (e.isIntersecting) {
            section.classList.add('is-in');
            if (reduce) section.classList.add('is-reduced');
            io.disconnect();
          }
        });
      }, { threshold: 0.18 });

      io.observe(section);

      // ===== Quick add micro-feedback =====
      section.querySelectorAll('[data-bm-buy]').forEach((btn) => {
        btn.addEventListener('click', () => {
          btn.classList.add('is-added');
          btn.textContent = 'Added ✓';
          setTimeout(() => { btn.classList.remove('is-added'); btn.textContent = 'Quick add'; }, 950);
        });
      });

      // ===== Wishlist (hearts) -> localStorage -> booking can read =====
      const WISH_KEY = 'bm:wishlist:v1';

      function readWish(){
        try{
          const raw = localStorage.getItem(WISH_KEY);
          const parsed = raw ? JSON.parse(raw) : [];
          return Array.isArray(parsed) ? parsed.map(String).filter(Boolean) : [];
        }catch(_e){
          return [];
        }
      }

      function writeWish(items){
        try{ localStorage.setItem(WISH_KEY, JSON.stringify(items)); }catch(_e){}
        // Same-tab signal (React widget can listen)
        window.dispatchEvent(new CustomEvent('bm:wishlist-change', { detail: { items } }));
      }

      function labelFrom(btn){
        const card = btn.closest('.bm-product');
        if (!card) return null;
        const name = card.querySelector('.bm-product__name')?.textContent?.trim();
        const price = card.querySelector('.bm-product__price')?.textContent?.trim();
        if (!name) return null;
        return price ? `${name} · ${price}` : name;
      }

      function syncWishBtn(btn, items){
        const label = labelFrom(btn);
        if (!label) return;
        const on = items.includes(label);
        btn.classList.toggle('is-wished', on);
        btn.setAttribute('aria-pressed', on ? 'true' : 'false');
        btn.setAttribute('data-bm-wish-label', label);
      }

      const wishBtns = Array.from(section.querySelectorAll('button.bm-icon'));
      if (wishBtns.length){
        let items = readWish();
        wishBtns.forEach((b) => syncWishBtn(b, items));

        wishBtns.forEach((b) => {
          b.addEventListener('click', () => {
            const label = labelFrom(b);
            if (!label) return;

            items = readWish();
            const idx = items.indexOf(label);
            if (idx >= 0) items.splice(idx, 1);
            else items.push(label);

            writeWish(items);
            wishBtns.forEach((x) => syncWishBtn(x, items));
          });
        });

        // Cross-tab sync
        window.addEventListener('storage', (e) => {
          if (e.key !== WISH_KEY) return;
          items = readWish();
          wishBtns.forEach((x) => syncWishBtn(x, items));
        });
      }

      // ===== Carousel logic =====
      const viewport = section.querySelector('[data-bm-viewport]');
      const track = section.querySelector('[data-bm-track]');
      const prev = section.querySelector('[data-bm-prev]');
      const next = section.querySelector('[data-bm-next]');
      const dotsWrap = section.querySelector('[data-bm-dots]');
      const dots = dotsWrap ? Array.from(dotsWrap.querySelectorAll('[data-bm-dot]')) : [];

      if (!viewport || !track) return;

      let isDown = false;
      let startX = 0;
      let startScroll = 0;

      const setDragging = (on) => viewport.classList.toggle('is-dragging', on);

      viewport.addEventListener('pointerdown', (e) => {
        isDown = true;
        viewport.setPointerCapture(e.pointerId);
        startX = e.clientX;
        startScroll = viewport.scrollLeft;
        setDragging(true);
      });

      viewport.addEventListener('pointermove', (e) => {
        if (!isDown) return;
        const dx = e.clientX - startX;
        viewport.scrollLeft = startScroll - dx;
      });

      function endDrag() { isDown = false; setDragging(false); }
      viewport.addEventListener('pointerup', endDrag);
      viewport.addEventListener('pointercancel', endDrag);
      viewport.addEventListener('mouseleave', endDrag);

      function cardStep() {
        const first = track.querySelector('.bm-product');
        if (!first) return 320;
        const rect = first.getBoundingClientRect();
        const styles = window.getComputedStyle(track);
        const gap = parseFloat(styles.columnGap || styles.gap || '14') || 14;
        return rect.width + gap;
      }

      function clamp(n, a, b){ return Math.max(a, Math.min(b, n)); }

      function activeIndex() {
        if (!dots.length) return 0;
        const step = cardStep();
        const idx = Math.round(viewport.scrollLeft / step);
        return clamp(idx, 0, dots.length - 1);
      }

      function scrollToIndex(idx) {
        const step = cardStep();
        const max = dots.length ? dots.length - 1 : 999;
        const t = clamp(idx, 0, max);
        viewport.scrollTo({ left: t * step, behavior: 'smooth' });
      }

      function syncDots(){
        if (!dots.length) return;
        const idx = activeIndex();
        dots.forEach((d, i) => d.classList.toggle('is-active', i === idx));
      }

      prev?.addEventListener('click', () => scrollToIndex(activeIndex() - 1));
      next?.addEventListener('click', () => scrollToIndex(activeIndex() + 1));

      dots.forEach((d) => {
        d.addEventListener('click', () => {
          const idx = parseInt(d.getAttribute('data-bm-dot') || '0', 10);
          scrollToIndex(idx);
        });
      });

      viewport.addEventListener('scroll', () => requestAnimationFrame(syncDots));

      viewport.addEventListener('keydown', (e) => {
        if (e.key === 'ArrowLeft') scrollToIndex(activeIndex() - 1);
        if (e.key === 'ArrowRight') scrollToIndex(activeIndex() + 1);
      });

      syncDots();
    })();
  </script>
</section>
