---
import "./_booking.css";
---

<section class="bm-book" id="book" aria-label="Booking">
  <div class="bm-book__wrap">
    <header class="bm-book__head">
      <p class="bm-book__kicker">BOOK ONLINE</p>
      <h2 class="bm-book__title">Pick a service. Slide a time. Done.</h2>
      <p class="bm-book__sub">No app. No account. Pay at the shop.</p>
    </header>

    <div class="bm-bookWidget" aria-label="Booking widget" data-bm-book-widget>
      <!-- LEFT: booking UI -->
      <div class="bm-bookWidget__left" aria-label="Time & service picker">
        <div class="bm-booking__top">
          <div class="bm-booking__title">Book in seconds</div>
          <div class="bm-booking__pill">Open 10:00–20:00</div>
        </div>

        <div class="bm-bookingMeta" aria-label="Selected service meta">
          <span class="bm-bookingMeta__dot" aria-hidden="true"></span>
          <span data-bm-svcmeta>Skin fade · 50 min · £28</span>
        </div>

        <div class="bm-chips" aria-label="Popular services">
          <button class="bm-chip is-active" type="button" data-bm-service="skinfade">
            Skin fade <strong>£28</strong>
          </button>
          <button class="bm-chip" type="button" data-bm-service="haircutbeard">
            Haircut + beard <strong>£30</strong>
          </button>
          <button class="bm-chip" type="button" data-bm-service="hottowel">
            Hot towel shave <strong>£18</strong>
          </button>
        </div>

        <div class="bm-slotTop">
          <span class="bm-slotTop__k">Times today</span>
          <span class="bm-slotTop__k bm-slotTop__soft">Swipe</span>
        </div>

        <div class="bm-timeCarousel" role="group" aria-label="Available times">
          <div class="bm-timeCarousel__fade bm-timeCarousel__fade--l" aria-hidden="true"></div>
          <div class="bm-timeCarousel__fade bm-timeCarousel__fade--r" aria-hidden="true"></div>
          <div class="bm-timeCarousel__track" data-bm-track></div>
        </div>

        <button class="bm-bookCta" type="button" data-bm-pickcta>
          Lock <span data-bm-pickedtime>10:00</span> — <span data-bm-pickedsvc>Skin fade</span>
          <span class="bm-bookCta__sheen" aria-hidden="true"></span>
        </button>

        <p class="bm-bookHint">No payment required · cancel anytime</p>
      </div>

      <!-- RIGHT: form -->
      <form class="bm-bookWidget__right" aria-label="Booking form">
        <div class="bm-formTop">
          <div class="bm-formTop__title">Your details</div>
          <div class="bm-formTop__mini" aria-label="Selection summary">
            <span class="bm-formTop__dot" aria-hidden="true"></span>
            <span data-bm-summary>Skin fade · 10:00</span>
          </div>
        </div>

        <!-- hidden values that update from the picker -->
        <input type="hidden" name="service" value="skinfade" data-bm-hidden-service />
        <input type="hidden" name="time" value="10:00" data-bm-hidden-time />

        <label class="bm-field">
          <span class="bm-field__label">Name</span>
          <input class="bm-input" name="name" autocomplete="name" placeholder="Your name" required />
        </label>

        <label class="bm-field">
          <span class="bm-field__label">Phone</span>
          <input class="bm-input" name="phone" autocomplete="tel" placeholder="+44…" required />
        </label>

        <label class="bm-field">
          <span class="bm-field__label">Notes (optional)</span>
          <textarea class="bm-input bm-input--area" name="notes" rows="4" placeholder="Any preferences?"></textarea>
        </label>

        <button class="bm-formBtn" type="submit">
          Request booking
          <span class="bm-formBtn__sheen" aria-hidden="true"></span>
        </button>

        <p class="bm-book__fine">We’ll confirm by text. No spam. No drama.</p>
      </form>
    </div>
  </div>

  <script is:inline>
    (function () {
      const widget = document.querySelector("[data-bm-book-widget]");
      if (!widget) return;

      // 10:00 -> 19:45 (open until 20:00), step 15m
      const START = 10 * 60;
      const END = 20 * 60;
      const STEP = 15;

      const pad = (n) => String(n).padStart(2, "0");
      const fmt = (mins) => `${pad(Math.floor(mins / 60))}:${pad(mins % 60)}`;

      const allTimes = [];
      for (let m = START; m < END; m += STEP) allTimes.push(fmt(m));

      function computeSoonest() {
        const now = new Date();
        const cur = now.getHours() * 60 + now.getMinutes();
        if (cur < START) return fmt(START);
        if (cur >= END) return fmt(START);
        const rounded = Math.ceil(cur / STEP) * STEP;
        return rounded >= END ? fmt(START) : fmt(rounded);
      }

      const soonestTime = computeSoonest();

      const services = {
        skinfade: { label: "Skin fade", mins: 50, price: "£28" },
        haircutbeard: { label: "Haircut + beard", mins: 60, price: "£30" },
        hottowel: { label: "Hot towel shave", mins: 30, price: "£18" },
      };

      const track = widget.querySelector("[data-bm-track]");
      const chipBtns = Array.from(widget.querySelectorAll("[data-bm-service]"));
      const meta = widget.querySelector("[data-bm-svcmeta]");
      const summary = widget.querySelector("[data-bm-summary]");

      const pickedTimeEl = widget.querySelector("[data-bm-pickedtime]");
      const pickedSvcEl = widget.querySelector("[data-bm-pickedsvc]");
      const hiddenSvc = widget.querySelector("[data-bm-hidden-service]");
      const hiddenTime = widget.querySelector("[data-bm-hidden-time]");

      const lockBtn = widget.querySelector("[data-bm-pickcta]");
      const nameInput = widget.querySelector('input[name="name"]');

      let activeServiceKey = "skinfade";
      let activeTime = soonestTime;

      function updateMeta() {
        const s = services[activeServiceKey];
        if (meta) meta.textContent = `${s.label} · ${s.mins} min · ${s.price}`;
        if (summary) summary.textContent = `${s.label} · ${activeTime}`;
        if (pickedTimeEl) pickedTimeEl.textContent = activeTime;
        if (pickedSvcEl) pickedSvcEl.textContent = s.label;
        if (hiddenSvc) hiddenSvc.value = activeServiceKey;
        if (hiddenTime) hiddenTime.value = activeTime;
      }

      function setActiveTime(t) {
        activeTime = t;
        Array.from(track.querySelectorAll("[data-time]")).forEach((b) =>
          b.classList.toggle("is-active", b.getAttribute("data-time") === t)
        );
        updateMeta();

        const btn = track.querySelector(`[data-time="${t}"]`);
        if (btn && btn.scrollIntoView) {
          btn.scrollIntoView({ behavior: "smooth", inline: "center", block: "nearest" });
        }
      }

      function renderTimes() {
        track.innerHTML = "";
        allTimes.forEach((t) => {
          const b = document.createElement("button");
          b.type = "button";
          b.className =
            "bm-timeChip" +
            (t === soonestTime ? " is-soonest" : "") +
            (t === activeTime ? " is-active" : "");
          b.setAttribute("data-time", t);

          b.innerHTML = `
            ${t === soonestTime ? '<span class="bm-timeChip__badge">Soonest</span>' : ""}
            <span class="bm-timeChip__time">${t}</span>
          `;

          b.addEventListener("click", () => setActiveTime(t));
          track.appendChild(b);
        });

        requestAnimationFrame(() => setActiveTime(activeTime));
      }

      function renderService(key) {
        activeServiceKey = key;
        chipBtns.forEach((b) =>
          b.classList.toggle("is-active", b.getAttribute("data-bm-service") === key)
        );
        updateMeta();
      }

      chipBtns.forEach((btn) => {
        btn.addEventListener("click", () =>
          renderService(btn.getAttribute("data-bm-service") || "skinfade")
        );
      });

      if (lockBtn) {
        lockBtn.addEventListener("click", () => {
          if (nameInput) nameInput.focus({ preventScroll: false });
        });
      }

      // demo submit
      const form = widget.querySelector("form");
      if (form) {
        form.addEventListener("submit", (e) => {
          e.preventDefault();
          const s = services[activeServiceKey];
          alert(`Requested: ${s.label} at ${activeTime}`);
        });
      }

      renderTimes();
      renderService(activeServiceKey);
      updateMeta();
    })();
  </script>
</section>
