---
const { id = "services" } = Astro.props;

import { SERVICE_CATEGORIES } from "./servicesCatalog";

const cats = SERVICE_CATEGORIES ?? [];
const N = cats.length;

// do pętli nieskończonej: [last, ...cats, first]
const loop = N > 1 ? [cats[N - 1], ...cats, cats[0]] : cats;

const bg = (img) =>
  `radial-gradient(700px 520px at 35% 30%, rgba(199,162,106,.18), transparent 60%), url("${img}")`;
---

<section class="bm-services" id={id} aria-label="Prices & Services" data-svc-root>
  <div class="bm-services__inner">
    <header class="bm-gal__head">
      <div>
        <p class="bm-gal__kicker">PRICES &amp; SERVICES.</p>
        <h2 class="bm-gal__title">Pick your service</h2>
        <p class="bm-gal__sub">Use the arrows — image, label and prices slide together.</p>
      </div>
    </header>

    <div class="bm-svcCarousel" aria-roledescription="carousel">
      <button class="bm-arrow bm-arrow--prev" type="button" aria-label="Previous category" data-svc-prev>
        <span aria-hidden="true">←</span>
      </button>

      <div class="bm-svcViewport" data-svc-viewport>
        <div class="bm-svcTrack" data-svc-track style="transform: translate3d(-100%,0,0);">
          {loop.map((c, idx) => (
            <article
              class="bm-svcSlide"
              aria-roledescription="slide"
              aria-label={`${c.label}`}
              data-svc-slide
              data-svc-logical={N > 1 ? String((idx - 1 + N) % N) : "0"}
            >
              <div class="bm-svcStage">
                <div
                  class="bm-circle bm-svcCircle"
                  role="img"
                  aria-label={`Service preview: ${c.label}`}
                  style={`background-image: ${bg(c.img)}`}
                ></div>

                <div class="bm-svcLabelWrap" aria-label="Category">
                  <div class="bm-svcLabel">{c.label}</div>
                </div>
              </div>

              <div class="bm-services__bottom">
                <div class="bm-services__prices" aria-label="Service price list">
                  <div class="bm-priceGrid">
                    {c.services.map((s) => (
                      <div class="bm-priceRow">
                        <span class="bm-priceRow__name">{s.name}</span>
                        <span class="bm-priceRow__dots" aria-hidden="true"></span>
                        <span class="bm-priceRow__price">{s.priceLabel}</span>
                      </div>
                    ))}
                  </div>
                </div>

                <div class="bm-services__mini" aria-label="Social proof">
                  <div class="bm-mini__badge">+10%</div>
                  <p class="bm-mini__text">
                    Most of our first-time clients book again within 30 days. Clean fades. Sharp beards. Zero drama.
                  </p>
                </div>
              </div>
            </article>
          ))}
        </div>
      </div>

      <button class="bm-arrow bm-arrow--next" type="button" aria-label="Next category" data-svc-next>
        <span aria-hidden="true">→</span>
      </button>
    </div>
  </div>

  <script is:inline>
    (() => {
      const root = document.querySelector("[data-svc-root]");
      if (!root) return;

      const track = root.querySelector("[data-svc-track]");
      const prev = root.querySelector("[data-svc-prev]");
      const next = root.querySelector("[data-svc-next]");
      const slides = track ? Array.from(track.querySelectorAll("[data-svc-slide]")) : [];

      const N = Math.max(0, slides.length);
      if (!track || !prev || !next || N <= 1) return;

      // Jeśli mamy loop: [last, ...cats, first] => real slides = N-2
      const real = N - 2;
      if (real <= 0) return;

      let idx = 1; // start on first real slide
      let locked = false;

      const setTransition = (on) => {
        track.style.transition = on ? "transform 460ms cubic-bezier(.2,.8,.2,1)" : "none";
      };

      const go = (i, animate = true) => {
        setTransition(animate);
        track.style.transform = `translate3d(${-i * 100}%,0,0)`;
      };

      const normalize = () => {
        // jeśli wjechaliśmy na klona po lewej/prawej, przeskocz bez animacji
        if (idx === 0) {
          idx = real;
          go(idx, false);
        } else if (idx === real + 1) {
          idx = 1;
          go(idx, false);
        }
      };

      const step = (dir) => {
        if (locked) return;
        locked = true;
        idx += dir;
        go(idx, true);
      };

      prev.addEventListener("click", () => step(-1));
      next.addEventListener("click", () => step(1));

      track.addEventListener("transitionend", () => {
        normalize();
        locked = false;
      });

      // init (pewnie)
      go(idx, false);
      requestAnimationFrame(() => go(idx, false));
    })();
  </script>
</section>
